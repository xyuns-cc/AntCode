# ğŸ—ï¸ AntCode ç³»ç»Ÿæ¶æ„æ·±åº¦è§£æ

æœ¬æ–‡æ¡£å°†å¸¦ä½ æ·±å…¥äº†è§£ AntCode çš„è®¾è®¡ç†å¿µã€åˆ†å±‚æ¶æ„ä»¥åŠå…³é”®çš„æ•°æ®æµè½¬æœºåˆ¶ã€‚

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

åœ¨è®¾è®¡ AntCode æ—¶ï¼Œæˆ‘ä»¬å§‹ç»ˆåšæŒä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™ï¼š

### 1. æ§åˆ¶ä¸æ‰§è¡Œåˆ†ç¦» (Separation of Control and Execution)
è¿™æ˜¯ç³»ç»Ÿç¨³å®šæ€§çš„åŸºçŸ³ã€‚
-   **æ§åˆ¶é¢ (Control Plane)**ï¼šè´Ÿè´£"æ€è€ƒ"ã€‚å®ƒå†³å®šä»€ä¹ˆæ—¶å€™è¿è¡Œä»»åŠ¡ï¼Œä»»åŠ¡è¯¥åˆ†å‘ç»™è°ã€‚å¦‚æœæ§åˆ¶é¢æŒ‚äº†ï¼Œä»…ä»…æ˜¯ä¸èƒ½äº§ç”Ÿæ–°ä»»åŠ¡ï¼Œæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¸å—å½±å“ã€‚
-   **æ‰§è¡Œé¢ (Execution Plane)**ï¼šè´Ÿè´£"è¡ŒåŠ¨"ã€‚å®ƒæ˜¯æ— çŠ¶æ€çš„ï¼Œåªç®¡æ‰§è¡Œæ”¶åˆ°çš„æŒ‡ä»¤ã€‚å¦‚æœæŸä¸ª Worker æŒ‚äº†ï¼Œæ§åˆ¶é¢ä¼šæ„ŸçŸ¥å¹¶é‡æ–°è°ƒåº¦ï¼Œä¸ä¼šæ‹–ç´¯æ•´ä¸ªç³»ç»Ÿã€‚

### 2. åŒæ¨¡æ¥å…¥ (Dual-Mode Transport)
ä¸ºäº†é€‚åº”ä¸åŒçš„ç½‘ç»œç¯å¢ƒï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸¤ç§ Worker æ¥å…¥æ¨¡å¼ï¼š
-   **Direct æ¨¡å¼**ï¼šWorker ç›´è¿ Redisã€‚é€‚ç”¨äºå†…ç½‘ç¯å¢ƒï¼Œé€šä¿¡é“¾è·¯æœ€çŸ­ï¼Œå»¶è¿Ÿæä½ã€‚
-   **Gateway æ¨¡å¼**ï¼šWorker é€šè¿‡ gRPC ç½‘å…³æ¥å…¥ã€‚é€‚ç”¨äºè·¨å…¬ç½‘ã€è·¨äº‘ç¯å¢ƒï¼ŒWorker æ— éœ€æš´éœ²åœ¨å…¬ç½‘ï¼Œå®‰å…¨æ€§æé«˜ã€‚

### 3. æ•°æ®éš”ç¦»ä¸è§„èŒƒ (Data Isolation)
ç”±äºç³»ç»Ÿæ¶‰åŠå¤šä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬ä¸¥æ ¼è§„å®šäº†æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™æƒé™ã€‚æ‰€æœ‰è¿è¡Œæ—¶æ•°æ®å¿…é¡»è½åœ¨ `data/` ç›®å½•ä¸‹ï¼Œä¸”åç«¯ä¸ Worker çš„æ•°æ®ç›®å½•ä¸¥æ ¼ç‰©ç†éš”ç¦»ã€‚

---

## ğŸ§© æœåŠ¡åˆ†å±‚æ¶æ„

AntCode çš„æ¶æ„å¯ä»¥æ¸…æ™°åœ°åˆ’åˆ†ä¸ºå››ä¸ªå¹³é¢ï¼š

| å¹³é¢ | æœåŠ¡ç»„ä»¶ | æ ¸å¿ƒèŒè´£ | å…³é”®æŠ€æœ¯ |
| :--- | :--- | :--- | :--- |
| **Control Plane** | `web_api` | **å¤§è„‘**ã€‚æä¾› RESTful APIï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚ã€é‰´æƒã€é…ç½®ç®¡ç†ä»¥åŠå…ƒæ•°æ®å­˜å‚¨ã€‚ | FastAPI, SQLAlchemy |
| **Schedule Plane** | `master` | **å¿ƒè„**ã€‚è´Ÿè´£ä»»åŠ¡çš„è°ƒåº¦åˆ†å‘ã€æ•…éšœæ£€æµ‹ã€é‡è¯•æœºåˆ¶ä»¥åŠæ•°æ®çš„ä¸€è‡´æ€§ç»´æŠ¤ã€‚ | Python AsyncIO, Redis Streams |
| **Data Plane** | `gateway` | **å…³å£**ã€‚ä¸ºå…¬ç½‘ Worker æä¾›ç»Ÿä¸€çš„ gRPC æ¥å…¥ç‚¹ï¼Œè´Ÿè´£è®¤è¯ã€é™æµä¸åè®®è½¬æ¢ã€‚ | gRPC, TLS |
| **Execution Plane** | `worker` | **æ‰‹è„š**ã€‚å®é™…æ‰§è¡Œä»»åŠ¡çš„èŠ‚ç‚¹ï¼Œæ”¯æŒæ²™ç®±éš”ç¦»ã€èµ„æºé™åˆ¶ä¸å®æ—¶æ—¥å¿—ä¸ŠæŠ¥ã€‚ | Subprocess, Streaming |

---

## ğŸ”„ å…³é”®æ•°æ®é“¾è·¯

### 1. ä»»åŠ¡è°ƒåº¦é“¾è·¯ (Task Flow)

ä¸€ä¸ªä»»åŠ¡ä»åˆ›å»ºåˆ°å®Œæˆï¼Œç»å†ä»¥ä¸‹æµè½¬ï¼š

1.  **æäº¤ (Submit)**: ç”¨æˆ·é€šè¿‡ API åˆ›å»ºä»»åŠ¡ï¼Œ`web_api` å°†ä»»åŠ¡å…ƒæ•°æ®å†™å…¥æ•°æ®åº“ (MySQL/PostgreSQL)ã€‚
2.  **è°ƒåº¦ (Schedule)**: `master` æ‰«æå¾…æ‰§è¡Œä»»åŠ¡ï¼Œæ ¹æ®è·¯ç”±ç­–ç•¥å°†å…¶æŠ•é€’åˆ° Redis Stream é˜Ÿåˆ—ã€‚
3.  **æ‹‰å– (Pull)**:
    -   **Direct Worker**: ç›´æ¥ä» Redis Stream `XREADGROUP` æ‹‰å–æ¶ˆæ¯ã€‚
    -   **Gateway Worker**: å‘èµ· gRPC `StreamTasks` è¯·æ±‚ï¼ŒGateway ä» Redis æ‹‰å–åè½¬å‘ç»™ Workerã€‚
4.  **æ‰§è¡Œ (Execute)**: Worker å‡†å¤‡ Python ç¯å¢ƒï¼Œä¸‹è½½ä»£ç ï¼Œå¯åŠ¨å­è¿›ç¨‹æ‰§è¡Œã€‚
5.  **ä¸ŠæŠ¥ (Report)**: æ‰§è¡Œç»“æœä¸çŠ¶æ€é€šè¿‡å’Œ**æ‹‰å–**ç›¸åçš„è·¯å¾„å›ä¼ ç»™ `web_api`ã€‚

### 2. æ—¥å¿—ä¼ è¾“é“¾è·¯ (Log Flow)

AntCode è¦æ±‚æ—¥å¿—ä¹Ÿæ˜¯å®æ—¶çš„ï¼š

1.  **é‡‡é›†**: Worker æ•è·å­è¿›ç¨‹çš„ `stdout/stderr`ã€‚
2.  **ä¼ è¾“**: 
    -   Worker å°†æ—¥å¿—åˆ†ç‰‡ (Chunk) å‹ç¼©ã€‚
    -   é€šè¿‡ Redis Stream (Direct) æˆ– gRPC Stream (Gateway) å‘é€ã€‚
3.  **æŒä¹…åŒ–**: `master` æˆ–ä¸“é—¨çš„ Log Consumer æ¶ˆè´¹æ—¥å¿—æµï¼Œå°†å…¶å†™å…¥æ–‡ä»¶å­˜å‚¨ (`data/backend/logs`) æˆ–æ—¶åºæ•°æ®åº“ã€‚

---

## ğŸ“ ä»£ç ç»„ç»‡ç»“æ„

æˆ‘ä»¬é‡‡ç”¨ Monorepo ç»“æ„ï¼Œä½†æ¨¡å—è¾¹ç•Œæ¸…æ™°ï¼š

```text
AntCode/
â”œâ”€â”€ packages/                  # ğŸŸ¢ å…±äº«åŸºåº§
â”‚   â”œâ”€â”€ antcode_core/          # åŒ…æ‹¬é¢†åŸŸå®ä½“ã€å·¥å…·ç±»ã€é…ç½®å¯¹è±¡
â”‚   â””â”€â”€ antcode_contracts/     # Proto å®šä¹‰ä¸ç”Ÿæˆçš„ä»£ç 
â”œâ”€â”€ services/                  # ğŸ”µ å¾®æœåŠ¡
â”‚   â”œâ”€â”€ web_api/               # æ§åˆ¶é¢ API
â”‚   â”œâ”€â”€ master/                # è°ƒåº¦å™¨
â”‚   â”œâ”€â”€ gateway/               # gRPC ç½‘å…³
â”‚   â””â”€â”€ worker/                # æ‰§è¡ŒèŠ‚ç‚¹
â”œâ”€â”€ contracts/proto/           # åŸå§‹ Proto æ–‡ä»¶
â”œâ”€â”€ infra/docker/              # å®¹å™¨ç¼–æ’é…ç½®
â””â”€â”€ data/                      # ğŸ”´ è¿è¡Œæ—¶æ•°æ® (Git Ignore)
```

---

## ğŸ”Œ Worker æ¥å…¥æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | Direct æ¨¡å¼ | Gateway æ¨¡å¼ |
| :--- | :--- | :--- |
| **é€‚ç”¨åœºæ™¯** | å†…ç½‘ã€ç§æœ‰äº‘ã€å•æœºå¼€å‘ | å…¬ç½‘ã€æ··åˆäº‘ã€è·¨åœ°åŸŸéƒ¨ç½² |
| **ä¾èµ–** | éœ€è¦ç›´è¿ Redis & DB (å¯é€‰) | ä»…éœ€è¿æ¥ Gateway ç«¯å£ (50051) |
| **é€šä¿¡åè®®** | Redis Protocol (RESP) | gRPC / HTTP2 |
| **å®‰å…¨æ€§** | ä¾èµ–ç½‘ç»œéš”ç¦» | ä¾èµ– API Key è®¤è¯ + TLS åŠ å¯† |
| **æ€§èƒ½** | æé«˜ (å°‘ä¸€è·³) | é«˜ (gRPC å¸¦æ¥çš„å¼€é”€å¾ˆå°) |

> **æœ€ä½³å®è·µ**: åœ¨ç”±äºåŒä¸€ VPC å†…ï¼Œä¼˜å…ˆä½¿ç”¨ Direct æ¨¡å¼ï¼›åªè¦è·¨è¶Šäº†ç½‘ç»œè¾¹ç•Œï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ Gateway æ¨¡å¼ã€‚

---

## ğŸš€ ä¸‹ä¸€æ­¥

- äº†è§£å¦‚ä½•é…ç½®æ•°æ®åº“ï¼š[Database Setup](database-setup.md)
- æ·±å…¥ Worker é…ç½®ï¼š[Worker Configuration](system-config.md)
