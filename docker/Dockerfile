# =====================================================
# AntCode API - å¤šé˜¶æ®µæ„å»º Dockerfile
# =====================================================

# ================== é˜¶æ®µ 1: åŸºç¡€é•œåƒ ==================
FROM python:3.11-slim as base

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    UV_SYSTEM_PYTHON=1

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… uvï¼ˆæ›´å¿«çš„ Python åŒ…ç®¡ç†å™¨ï¼‰
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:${PATH}"

# ================== é˜¶æ®µ 2: ä¾èµ–å®‰è£… ==================
FROM base as builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY pyproject.toml uv.lock* ./

# æ ¹æ®æ„å»ºå‚æ•°å®‰è£…ä¾èµ–
# æ”¯æŒé€šè¿‡ --build-arg DB_TYPE=mysql æ¥æŒ‡å®šæ•°æ®åº“ç±»å‹
ARG DB_TYPE=sqlite
RUN if [ "$DB_TYPE" = "mysql" ]; then \
        echo "ğŸ“¦ å®‰è£… MySQL ä¾èµ–..." && \
        uv sync --extra mysql; \
    elif [ "$DB_TYPE" = "postgres" ]; then \
        echo "ğŸ“¦ å®‰è£… PostgreSQL ä¾èµ–..." && \
        uv sync --extra postgres; \
    elif [ "$DB_TYPE" = "all" ]; then \
        echo "ğŸ“¦ å®‰è£…æ‰€æœ‰æ•°æ®åº“ä¾èµ–..." && \
        uv sync --extra all-db; \
    else \
        echo "ğŸ“¦ å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆSQLiteï¼‰..." && \
        uv sync; \
    fi

# ================== é˜¶æ®µ 3: è¿è¡Œæ—¶é•œåƒ ==================
FROM base as runtime

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶å·²å®‰è£…çš„ä¾èµ–
COPY --from=builder /root/.local /root/.local
COPY --from=builder /app/.venv /app/.venv

# è®¾ç½®è™šæ‹Ÿç¯å¢ƒè·¯å¾„
ENV PATH="/app/.venv/bin:$PATH"

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY src ./src
COPY main.py ./

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p \
    /app/storage/projects/files \
    /app/storage/projects/extracted \
    /app/storage/projects/executions \
    /app/storage/venvs/shared \
    /app/storage/mise/cache \
    /app/logs/tasks \
    /app/migrations

# è®¾ç½®ç›®å½•æƒé™
RUN chmod -R 755 /app/storage /app/logs

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/api/v1/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["python", "main.py"]
