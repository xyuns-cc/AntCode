# AntCode 环境配置文件示例
# 复制此文件为 .env 并根据需要修改

# ============ 数据库配置 ============
# 留空使用默认 SQLite（存储在 data/backend/db/antcode.sqlite3）
DATABASE_URL=

# MySQL 示例
# DATABASE_URL=mysql+asyncmy://user:password@localhost:3306/antcode

# PostgreSQL 示例
# DATABASE_URL=postgresql://user:password@localhost:5432/antcode

# ============ Redis 配置 ============
# 留空使用内存缓存
# 格式: redis://[:password]@host:port/db
REDIS_URL=

# ============ 抽象后端配置 ============
# 爬虫后端类型: "memory" (默认，零依赖) 或 "redis" (生产模式，支持多 Master)
# 使用 redis 时必须配置 REDIS_URL
CRAWL_BACKEND=memory

# 文件存储后端类型: "s3" (必须，新架构强制要求)
# 新架构要求所有文件项目必须存储到 S3，Worker 通过预签名 URL 下载
# 本地存储 "local" 仅供旧架构兼容，新架构禁止使用
FILE_STORAGE_BACKEND=s3

# 日志存储后端类型: "s3" (默认) 或 "local" (本地文件) 或 "clickhouse" (预留)
LOG_STORAGE_BACKEND=s3

# ============ S3/MinIO 公共配置 ============
# 文件存储和日志存储共用同一套 S3 配置
# 当 FILE_STORAGE_BACKEND=s3 或 LOG_STORAGE_BACKEND=s3 时需要配置

# 方式一：AWS S3 风格配置
# S3_ENDPOINT_URL=http://localhost:9000
# S3_ACCESS_KEY=minioadmin
# S3_SECRET_KEY=minioadmin
# S3_REGION=us-east-1
# S3_BUCKET=antcode  # 文件存储桶（日志存储默认使用 antcode-logs）

# 方式二：MinIO 风格配置（Docker 环境推荐）
# MINIO_ENDPOINT=localhost:9000
# MINIO_ACCESS_KEY=minioadmin
# MINIO_SECRET_KEY=minioadmin
# MINIO_BUCKET=antcode

# Worker 凭证存储类型在 node_config.yaml 的 credential_store 中配置


# ============ Worker 日志缓冲配置 ============
# 日志缓冲区大小（达到此数量触发批量发送到 Master）
LOG_BUFFER_SIZE=50
# 日志刷新间隔（秒，超过此时间自动刷新）
LOG_FLUSH_INTERVAL=2.0
# 日志缓冲区最大行数（超过则丢弃最旧日志，防止内存溢出）
LOG_BUFFER_MAX_LINES=500

# ============ Worker 项目缓存配置 ============
# 项目缓存最大数量（超过则按 LRU 策略淘汰）
PROJECT_CACHE_MAX_SIZE=100
# 项目缓存 TTL（小时，超过此时间未访问的项目标记为淘汰候选）
PROJECT_CACHE_TTL_HOURS=168

# ============ 爬虫数据存储配置 ============
# 是否启用爬虫数据 Redis 存储
SPIDER_DATA_ENABLED=true
# 批量写入大小（达到此数量触发批量写入）
SPIDER_DATA_BATCH_SIZE=50
# 刷新间隔（秒，超过此时间自动刷新缓冲区）
SPIDER_DATA_FLUSH_INTERVAL=5.0
# 数据过期时间（秒，默认 24 小时）
SPIDER_DATA_TTL=86400
# 单次爬取最大数据条数
SPIDER_DATA_MAX_ITEMS=10000
# Redis Stream 最大长度
SPIDER_STREAM_MAX_LEN=10000

# ============ 服务器配置 ============
SERVER_HOST=0.0.0.0
SERVER_PORT=8000
SERVER_DOMAIN=localhost

# ============ 安全配置 ============
# CORS 允许的来源（逗号分隔，生产环境请设置具体域名）
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

# 是否允许连接私有网络节点（仅限内网部署时设为 true）
ALLOW_PRIVATE_NODES=false

# 是否验证告警 Webhook 的 SSL 证书（生产环境建议 true）
ALERT_VERIFY_SSL=true

# ============ 前端配置 ============
FRONTEND_PORT=3000

# ============ 日志配置 ============
LOG_LEVEL=INFO
LOG_FORMAT=text
LOG_TO_FILE=true

# ============ ClickHouse 配置（当 LOG_STORAGE_BACKEND=clickhouse 时使用） ============
# CLICKHOUSE_HOST=localhost
# CLICKHOUSE_PORT=8123
# CLICKHOUSE_DATABASE=antcode
# CLICKHOUSE_USER=default
# CLICKHOUSE_PASSWORD=
# CLICKHOUSE_RETENTION_DAYS=30



# ============ gRPC 配置（Gateway 服务） ============
# 是否启用 gRPC 服务（Worker <-> Gateway）
GRPC_ENABLED=true
# gRPC 服务端口
GRPC_PORT=50051
# gRPC 最大工作线程数
GRPC_MAX_WORKERS=10
# gRPC 心跳间隔（秒）
GRPC_HEARTBEAT_INTERVAL=30
# gRPC 心跳超时（秒）- 超过此时间未收到心跳则标记节点离线
GRPC_HEARTBEAT_TIMEOUT=90
# gRPC 优雅关闭等待时间（秒）
GRPC_SHUTDOWN_GRACE_PERIOD=5.0
# gRPC TLS 证书路径（可选，留空使用非加密连接）
GRPC_TLS_CERT_PATH=
# gRPC TLS 密钥路径（可选）
GRPC_TLS_KEY_PATH=
# gRPC TLS CA 路径（可选，启用 mTLS）
GRPC_TLS_CA_PATH=

# ============ Worker 双模式接入配置 ============
# Worker 通过 transport.mode 明确选择接入方式：
# - direct: 内网直连 Redis Streams（90% 场景，低延迟高吞吐）
# - gateway: 公网仅连 gRPC 网关（10% 场景，Redis/MySQL 不暴露公网）
#
# ⚠️ 强制二选一：direct 模式禁止配置 gateway，gateway 模式禁止配置 redis_url

# 传输模式（必填）: direct | gateway
WORKER_TRANSPORT_MODE=gateway

# Worker 节点 ID（必填）
WORKER_ID=worker-001

# Worker 安装 Key（前端生成，用于首次注册）
# 支持别名: WORKER_KEY
ANTCODE_WORKER_KEY=

# ---------- Direct 模式配置（内网） ----------
# 仅当 WORKER_TRANSPORT_MODE=direct 时生效
# WORKER_REDIS_URL=redis://10.0.0.10:6379/0
# WORKER_CONSUMER_GROUP=antcode-workers

# ---------- Gateway 模式配置（公网） ----------
# 仅当 WORKER_TRANSPORT_MODE=gateway 时生效
WORKER_GATEWAY_HOST=localhost
WORKER_GATEWAY_PORT=50051

# TLS 配置（生产环境强烈建议启用）
WORKER_GATEWAY_TLS=false
# WORKER_CA_CERT=./data/worker/secrets/ca.crt

# mTLS 客户端证书（可选，与 API Key 二选一）
# WORKER_CLIENT_CERT=./data/worker/secrets/client.crt
# WORKER_CLIENT_KEY=./data/worker/secrets/client.key

# API Key 认证（与 mTLS 二选一）
# WORKER_API_KEY=ak_your_worker_api_key

# ---------- Gateway 服务端配置 ----------
GATEWAY_HOST=0.0.0.0
GATEWAY_PORT=50051
